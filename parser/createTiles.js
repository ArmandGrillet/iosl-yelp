/*jslint node: true */
'use strict';

var async = require('async');
var fs = require('fs');
var parserUtils = require('./parserUtils.js');
var utils = require('../queries/utils');

function getAllBusinessesIn(city, callback) {
    utils.askDrill("select business_id, latitude, longitude from " + utils.datasetPath('business') + " where city='" + city + "'", function(answer) {
        callback(answer.rows);
    });
}

var cities = { // Cities we show in the webapp with their coordinates.
    // Charlotte NE = 35.2455, -80.8065
    // Charlotte W = OSEF, -80.8665
    // Charlotte S = 35.195499999999996, OSEF
    'Charlotte': {
        latitude: 35.227087,
        longitude: -80.843127,
        north: 35.2455,
        east: -80.8065,
        south: 35.195499999999996,
        west: -80.8665
    },
    'Pittsburgh': {
        latitude: 40.440625,
        longitude: -79.995886,
        north: 40.497400481034205,
        east: -79.9435767776237,
        south: 40.368043080121005,
        west: -80.07341183635705
    },
    'Champaign': {
        latitude: 40.11642,
        longitude: -88.24338,
        north: 40.13897268267053,
        east: -88.22789194852214,
        south: 40.09136197261219,
        west: -88.24903605411703
    },
    'Phoenix': {
        latitude: 33.448377,
        longitude: -112.074037,
        north: 33.5115,
        east: -111.9845,
        south: 33.429500000000004,
        west: -112.13750000000002
    },
    'Las Vegas': {
        latitude: 36.169941,
        longitude: -115.139830,
        north: 36.1875,
        east: -115.1155,
        south: 36.0625,
        west: -115.25150000000001
    },
    'Madison': {
        latitude: 43.073052,
        longitude: -89.401230,
        north: 43.104499999999994,
        east: -89.3415,
        south: 43.0575,
        west: -89.42849999999999
    },
    'Montreal': {
        latitude: 45.501689,
        longitude: -73.567256,
        north: 45.5385,
        east: -73.54149999999998,
        south: 45.460499999999996,
        west: -73.65350000000001
    },
    'Waterloo': {
        latitude: 43.4668000,
        longitude: -80.5163900,
        north: 43.4895,
        east: -80.49349999999998,
        south: 43.4555,
        west: -80.54650000000001
    },
    'Karlsruhe': {
        latitude: 49.006890,
        longitude: 8.403653,
        north: 49.017500000000005,
        east: 8.444500000000001,
        south: 48.993500000000004,
        west: 8.3545
    },
    'Edinburgh': {
        latitude: 55.953252,
        longitude: -3.188267,
        north: 55.97896608755005,
        east: -3.168103793235543,
        south: 55.92416885521877,
        west: -3.235493187672561
    },
};

function metersToDegrees(distance, latitude) {
    //Earth’s radius, sphere
    var radius = 6378137;

    //Coordinate offsets in radians
    var newLatitude = distance / radius;
    var newLongitude = distance / (radius * Math.cos(Math.PI * latitude / 180));

    //OffsetPosition, decimal degrees
    return {
        'latitude': newLatitude * 180 / Math.PI,
        'longitude': newLongitude * 180 / Math.PI
    };
}

var city; // Name of the city where we have to proceed

// Processing the parameters.
process.argv.forEach(function(val, index, array) {
    switch (index) {
        case 2:
            if (val === 'LV') {
                city = 'Las Vegas';
            } else {
                city = utils.capitalizeFirstLetter(val);
            }
            break;
        default:
            break;
    }
});

if (city === undefined) {
    console.log('Usage: node tiles CITY. E.g. \'node tiles Edinburgh\' will create a Edinburgh.geojson file');
}

getAllBusinessesIn(city, function(businesses) {
    var hundredMetersInCoordinates = metersToDegrees(100, cities[city].latitude);

    var minLat, maxLat, minLon, maxLon;
    if (cities[city].south < cities[city].north) {
        minLat = cities[city].south;
        maxLat = cities[city].north;
    } else {
        minLat = cities[city].north;
        maxLat = cities[city].south;
    }

    if (cities[city].east < cities[city].west) {
        minLon = cities[city].east;
        maxLon = cities[city].west;
    } else {
        minLon = cities[city].west;
        maxLon = cities[city].east;
    }


    var json = {
        "type": "FeatureCollection",
        "features": []
    };

    var businessesInTile = [];
    var i, j, k;

    for (i = minLat; i < maxLat; i += hundredMetersInCoordinates.latitude) { // 0.001° = 111.32 m
        for (j = minLon; j < maxLon; j += hundredMetersInCoordinates.longitude) {
            businessesInTile = [];
            for (k = 0; k < businesses.length; k++) {
                if (businesses[k].latitude >= i && businesses[k].latitude <= i + hundredMetersInCoordinates.latitude && businesses[k].longitude >= j && businesses[k].longitude <= j + hundredMetersInCoordinates.longitude) {
                    businessesInTile.push(businesses[k].business_id);
                }
            }
            json.features.push({
                "type": "Feature",
                "geometry": {
                    "type": "Polygon",
                    "coordinates": [
                        [i, j],
                        [i, j + hundredMetersInCoordinates.longitude],
                        [i + hundredMetersInCoordinates.latitude, j + hundredMetersInCoordinates.longitude],
                        [i + hundredMetersInCoordinates.latitude, j]
                    ]
                },
                "properties": {
                    "business_ids": businessesInTile
                }
            });
        }
    }

    // var lightweightJSON = {
    //     "type": "FeatureCollection",
    //     "features": []
    // };
    // Edinburgh
    // var lowestPointsForEdinburgh = [[55.9906441862436, -3.331763751154016], [55.98884755567536, -3.330159241762659], [55.98884755567536, -3.328554732371301], [55.987949240391245, -3.326950222979943], [55.98705092510713, -3.325345713588586], [55.986152609823, -3.323741204197228], [55.985254294538876, -3.3221366948058706], [55.985254294538876, -3.320532185414513], [55.984355979254765, -3.318927676023155], [55.983457663970654, -3.317323166631798], [55.984355979254765, -3.3157186572404402], [55.984355979254765, -3.3141141478490828], [55.983457663970654, -3.3125096384577253], [55.983457663970654, -3.3109051290663674], [55.983457663970654, -3.3093006196750103], [55.983457663970654, -3.3076961102836524], [55.98255934868653, -3.3060916008922945], [55.9816610334024, -3.3044870915009374], [55.9816610334024, -3.3028825821095795], [55.980762718118285, -3.301278072718222], [55.9816610334024, -3.299673563326864], [55.9816610334024, -3.2980690539355066], [55.9816610334024, -3.2964645445441496], [55.980762718118285, -3.2948600351527917], [55.980762718118285, -3.293255525761434], [55.97986440283417, -3.2916510163700763], [55.97986440283417, -3.290046506978719], [55.97986440283417, -3.2884419975873618], [55.97986440283417, -3.286837488196004], [55.980762718118285, -3.285232978804646], [55.980762718118285, -3.2836284694132885], [55.980762718118285, -3.282023960021931], [55.980762718118285, -3.2804194506305735], [55.980762718118285, -3.278814941239216], [55.980762718118285, -3.277210431847858], [55.980762718118285, -3.2756059224565006], [55.980762718118285, -3.274001413065143], [55.980762718118285, -3.2723969036737857], [55.980762718118285, -3.270792394282428], [55.980762718118285, -3.2691878848910703], [55.980762718118285, -3.267583375499713], [55.980762718118285, -3.2659788661083553], [55.97986440283417, -3.2643743567169974], [55.97986440283417, -3.2627698473256403], [55.980762718118285, -3.2611653379342824], [55.9816610334024, -3.259560828542925], [55.9816610334024, -3.2579563191515675], [55.98255934868653, -3.2563518097602095], [55.983457663970654, -3.2547473003688525], [55.983457663970654, -3.2531427909774946], [55.984355979254765, -3.251538281586137], [55.984355979254765, -3.2499337721947796], [55.984355979254765, -3.2483292628034217], [55.984355979254765, -3.2467247534120647], [55.984355979254765, -3.2451202440207068], [55.984355979254765, -3.243515734629349], [55.984355979254765, -3.241911225237992], [55.984355979254765, -3.240306715846634], [55.984355979254765, -3.2387022064552764], [55.985254294538876, -3.237097697063919], [55.985254294538876, -3.235493187672561], [55.985254294538876, -3.233888678281204], [55.986152609823, -3.232284168889846], [55.987949240391245, -3.2306796594984886], [55.987949240391245, -3.229075150107131], [55.987949240391245, -3.227470640715773], [55.987949240391245, -3.225866131324416], [55.987949240391245, -3.224261621933058], [55.987949240391245, -3.2226571125417003], [55.9816610334024, -3.2210526031503433], [55.980762718118285, -3.2194480937589853], [55.980762718118285, -3.217843584367628], [55.980762718118285, -3.21623907497627], [55.980762718118285, -3.2146345655849125], [55.980762718118285, -3.2130300561935554], [55.980762718118285, -3.2114255468021975], [55.980762718118285, -3.20982103741084], [55.980762718118285, -3.208216528019482], [55.980762718118285, -3.2066120186281246], [55.980762718118285, -3.2050075092367676], [55.9816610334024, -3.2034029998454097], [55.9816610334024, -3.2017984904540517], [55.9816610334024, -3.2001939810626943], [55.9816610334024, -3.198589471671337], [55.9816610334024, -3.1969849622799797], [55.986152609823, -3.195380452888622], [55.986152609823, -3.193775943497264], [55.98705092510713, -3.1921714341059064], [55.987949240391245, -3.190566924714549], [55.987949240391245, -3.1889624153231915], [55.98884755567536, -3.187357905931834], [55.98974587095948, -3.185753396540476], [55.98255934868653, -3.1841488871491186], [55.9816610334024, -3.182544377757761], [55.980762718118285, -3.180939868366403], [55.9816610334024, -3.179335358975046], [55.98255934868653, -3.1777308495836882], [55.983457663970654, -3.1761263401923308], [55.98255934868653, -3.1745218308009733], [55.9816610334024, -3.1729173214096154], [55.97986440283417, -3.1713128120182583], [55.97986440283417, -3.1697083026269004], [55.97986440283417, -3.168103793235543],
    //     [55.97896608755005, -3.1664992838441854], [55.97896608755005, -3.1648947744528275], [55.97806777226593, -3.1632902650614705], [55.97716945698181, -3.1616857556701126], [55.97716945698181, -3.1600812462787546], [55.97716945698181, -3.1584767368873976], [55.97716945698181, -3.1568722274960397], [55.97716945698181, -3.1552677181046827], [55.97716945698181, -3.1536632087133247], [55.97716945698181, -3.152058699321967], [55.97627114169769, -3.1504541899306098], [55.97627114169769, -3.148849680539252], [55.975372826413576, -3.1472451711478944], [55.975372826413576, -3.145640661756537], [55.97447451112945, -3.144036152365179], [55.973576195845325, -3.142431642973822], [55.972677880561214, -3.140827133582464], [55.97177956527709, -3.139222624191106], [55.97088124999297, -3.137618114799749], [55.969084619424734, -3.136013605408391], [55.968186304140616, -3.134409096017034], [55.9672879888565, -3.132804586625676], [55.96638967357237, -3.1312000772343183], [55.96549135828825, -3.1295955678429612], [55.964593043004136, -3.1279910584516033], [55.963694727720025, -3.126386549060246], [55.96279641243589, -3.124782039668888], [55.961898097151774, -3.1231775302775304], [55.961898097151774, -3.1215730208861734], [55.960999781867656, -3.1199685114948155], [55.96010146658354, -3.1183640021034575], [55.95920315129942, -3.1167594927121], [55.9583048360153, -3.1151549833207426], [55.9583048360153, -3.1151549833207426], [55.95740652073118, -3.1119459645380276], [55.95650820544706, -3.1103414551466697], [55.95650820544706, -3.1087369457553122], [55.95560989016295, -3.1071324363639548], [55.95471157487882, -3.1055279269725973], [55.953813259594696, -3.10392341758124], [55.953813259594696, -3.102318908189882], [55.952914944310585, -3.1007143987985244], [55.95201662902646, -3.099109889407167], [55.95111831374234, -3.097505380015809], [55.95111831374234, -3.095900870624452], [55.95021999845822, -3.094296361233094], [55.949321683174105, -3.0926918518417366], [55.949321683174105, -3.091087342450379], [55.95021999845822, -3.089482833059021], [55.95021999845822, -3.087878323667664], [55.949321683174105, -3.086273814276306], [55.949321683174105, -3.0846693048849487], [55.949321683174105, -3.0830647954935912], [55.94842336788998, -3.0814602861022333], [55.94842336788998, -3.0798557767108763], [55.94752505260587, -3.0782512673195184], [55.94752505260587, -3.0766467579281604], [55.94662673732174, -3.0750422485368034], [55.94662673732174, -3.0734377391454455]];
    // var centerTile;
    // for (i = 0; i < json.features.length; i++) {
    //     centerTile = utils.getCenterTile(json.features[i].geometry.coordinates);
    //     for (j = 0; j < lowestPointsForEdinburgh.length; j++) {
    //         if (centerTile.longitude === lowestPointsForEdinburgh[j][1]) {
    //             if (centerTile.latitude >= lowestPointsForEdinburgh[j][0]) {
    //                 console.log('Trop haut !');
    //             } else {
    //                 lightweightJSON.features.push(json.features[i]);
    //             }
    //         }
    //     }
    // }
    fs.writeFileSync('../static/grid/' + city + '.geojson', JSON.stringify(json));
});
